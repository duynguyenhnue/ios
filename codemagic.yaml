workflows:
  ios-build:
    name: iOS build
    environment:
      xcode: latest
      cocoapods: default
      ruby: 3.1.0
      vars:
        GITHUB_USER: ${{github.username}}
        GITHUB_TOKEN: ${{github.token}}
    triggering:
      events:
        - push
        - pull_request
    scripts:
      - name: Cài đặt Homebrew và các gói liên quan
        script: |
          brew update
          brew upgrade
          brew install openssl readline libyaml gmp
      - name: Thiết lập các biến môi trường
        script: |
          export PATH="/opt/homebrew/opt/openssl@3/bin:$PATH"
          export LDFLAGS="-L/opt/homebrew/opt/openssl@3/lib"
          export CPPFLAGS="-I/opt/homebrew/opt/openssl@3/include"
          export PKG_CONFIG_PATH="/opt/homebrew/opt/openssl@3/lib/pkgconfig"
      - name: Cài đặt Ruby 3.1.0
        script: |
          RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@3) --with-readline-dir=$(brew --prefix readline) --with-libyaml-dir=$(brew --prefix libyaml) --with-gmp-dir=$(brew --prefix gmp)" rbenv install 3.1.0
      - name: Cài đặt Bundler
        script: |
          gem install bundler
      - name: Cài đặt các phụ thuộc từ Gemfile
        script: |
          bundle install || echo "No Gemfile found, skipping bundle install"
      - name: Cài đặt CocoaPods
        script: |
          cd ios
          bundle exec pod install
      - name: Build ứng dụng iOS
        script: |
          xcodebuild -workspace ios/Uniqlo.xcodeproj -scheme Uniqlo -sdk iphoneos -configuration Release archive -archivePath $CM_BUILD_DIR/build/Uniqlo.xcarchive
      - name: Export IPA
        script: |
          xcodebuild -exportArchive -archivePath $CM_BUILD_DIR/build/Uniqlo.xcarchive -exportOptionsPlist ios/ExportOptions.plist -exportPath $CM_BUILD_DIR/build/Uniqlo.ipa
    artifacts:
      - $CM_BUILD_DIR/build/Uniqlo.ipa
    publishing:
      email:
        recipients:
          - your-email@example.com
